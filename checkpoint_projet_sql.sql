create database project_SQL;

use project_SQL;

-- Le checkpoint étant assez compliqué pour ce que l'on a appris...
-- ...J'ai décidé de le faire à ma manière en créant mes propres tables mais tout en suivant les consignes de l'exercice

-- Table CATÉGORIES
CREATE TABLE CATÉGORIES (
    CODE_CATEGORIE INT PRIMARY KEY,
    NOM_CATEGORIE NVARCHAR(50),
    DESCRIPTION NVARCHAR(255)
);

-- Table CLIENTS
CREATE TABLE CLIENTS (
    CODE_CLIENT INT PRIMARY KEY,
    ENTREPRISE NVARCHAR(100),
    ADRESSE NVARCHAR(255),
    VILLE NVARCHAR(50),
    CODE_POSTAL NVARCHAR(10),
    PAYS NVARCHAR(50),
    TÉLÉPHONE NVARCHAR(20),
    TÉLÉCOPIE NVARCHAR(20)
);

-- Table COMMANDES
CREATE TABLE COMMANDES (
    NUMÉRO_COMMANDE INT PRIMARY KEY,
    CODE_CLIENT INT FOREIGN KEY REFERENCES CLIENTS(CODE_CLIENT),
    NUMÉRO_EMPLOYÉ INT,
    DATE_COMMANDE DATE,
    DATE_EXPÉDITION DATE,
    FRAIS_EXPÉDITION DECIMAL(10, 2)
);

-- Table DÉTAILS_DE_LA_COMMANDE
CREATE TABLE DÉTAILS_DE_LA_COMMANDE (
    NUMÉRO_COMMANDE INT FOREIGN KEY REFERENCES COMMANDES(NUMÉRO_COMMANDE),
    RÉFÉRENCE_PRODUIT INT,
    PRIX_UNITAIRE DECIMAL(10, 2),
    QUANTITÉ INT,
    REMISE DECIMAL(5, 2),
    PRIMARY KEY (NUMÉRO_COMMANDE, RÉFÉRENCE_PRODUIT)
);

-- Table EMPLOYÉS
CREATE TABLE EMPLOYÉS (
    NUMÉRO_EMPLOYÉ INT PRIMARY KEY,
    RAPPORTEUR_À INT,
    NOM_DE_FAMILLE NVARCHAR(50),
    PRÉNOM NVARCHAR(50),
    POSTE NVARCHAR(50),
    TITRE NVARCHAR(50),
    DATE_NAISSANCE DATE,
    DATE_EMBAUCHE DATE,
    SALAIRE DECIMAL(10, 2),
    COMMISSION DECIMAL(10, 2)
);

-- Table FOURNISSEURS
CREATE TABLE FOURNISSEURS (
    NUMÉRO_FOURNISSEUR INT PRIMARY KEY,
    SOCIÉTÉ NVARCHAR(100),
    ADRESSE NVARCHAR(255),
    VILLE NVARCHAR(50),
    CODE_POSTAL NVARCHAR(10),
    PAYS NVARCHAR(50),
    TÉLÉPHONE NVARCHAR(20),
    TÉLÉCOPIE NVARCHAR(20)
);

-- Table PRODUITS
CREATE TABLE PRODUITS (
    RÉFÉRENCE_PRODUIT INT PRIMARY KEY,
    NOM_PRODUIT NVARCHAR(100),
    NUMÉRO_FOURNISSEUR INT FOREIGN KEY REFERENCES FOURNISSEURS(NUMÉRO_FOURNISSEUR),
    CODE_CATEGORIE INT FOREIGN KEY REFERENCES CATÉGORIES(CODE_CATEGORIE),
    QUANTITÉ NVARCHAR(50),
    PRIX_UNITAIRE DECIMAL(10, 2),
    UNITÉS_EN_STOCK INT,
    UNITÉS_SUR_COMMANDE INT,
    INDISPONIBLE INT
);

-- Insertion dans CATÉGORIES
INSERT INTO CATÉGORIES VALUES (1, 'Boissons', 'Boissons chaudes et froides');
INSERT INTO CATÉGORIES VALUES (2, 'Desserts', 'Gâteaux, biscuits et autres douceurs');

-- Insertion dans CLIENTS
INSERT INTO CLIENTS VALUES (1, 'Client A', '1 rue principale', 'Paris', '75000', 'France', '0102030405', '0102030406');
INSERT INTO CLIENTS VALUES (2, 'Client B', '2 avenue des Champs', 'Lyon', '69000', 'France', '0203040506', '0203040507');

-- Insertion dans COMMANDES
INSERT INTO COMMANDES VALUES (1, 1, 101, '2023-01-10', '2023-01-15', 50.00);
INSERT INTO COMMANDES VALUES (2, 2, 102, '2023-01-12', '2023-01-18', 30.00);

-- Insertion dans DÉTAILS_DE_LA_COMMANDE
INSERT INTO DÉTAILS_DE_LA_COMMANDE VALUES (1, 1, 20.00, 2, 0.10);
INSERT INTO DÉTAILS_DE_LA_COMMANDE VALUES (2, 2, 15.00, 3, 0.05);

-- Insertion dans EMPLOYÉS
INSERT INTO EMPLOYÉS VALUES (101, NULL, 'Dupont', 'Jean', 'Manager', 'Directeur', '1980-05-10', '2010-06-15', 9000.00, 500.00);
INSERT INTO EMPLOYÉS VALUES (102, 101, 'Durand', 'Marie', 'Technicien', 'Technicien Supérieur', '1985-08-20', '2015-07-10', 7000.00, NULL);

-- Insertion dans FOURNISSEURS
INSERT INTO FOURNISSEURS VALUES (1, 'Fournisseur A', '5 rue des Lilas', 'Lille', '59000', 'France', '0304050607', '0304050608');
INSERT INTO FOURNISSEURS VALUES (2, 'Fournisseur B', '8 place du Marché', 'Marseille', '13000', 'France', '0405060708', '0405060709');

-- Insertion dans PRODUITS
INSERT INTO PRODUITS VALUES (1, 'Eau Minérale', 1, 1, 'bouteille(s)', 1.00, 100, 50, 0);
INSERT INTO PRODUITS VALUES (2, 'Biscuit Chocolat', 2, 2, 'boîte(s)', 2.50, 200, 100, 0);

-- 1 Afficher par ordre décroissant d'ancienneté les employés de sexe masculin dont le salaire net est supérieur ou égal à 8000

-- 2 Affichez les produits répondant aux critères spécifiés

SELECT 
    RÉFÉRENCE_PRODUIT, 
    NOM_PRODUIT, 
    NUMÉRO_FOURNISSEUR, 
    UNITÉS_SUR_COMMANDE, 
    PRIX_UNITAIRE
FROM 
    PRODUITS
WHERE 
    QUANTITÉ LIKE '%bouteille%' AND
    SUBSTRING(NOM_PRODUIT, 3, 1) IN ('t', 'T') AND
    NUMÉRO_FOURNISSEUR IN (1, 2, 3) AND
    PRIX_UNITAIRE BETWEEN 70 AND 200 AND
    UNITÉS_SUR_COMMANDE IS NOT NULL;

-- 3 Affichez les clients dans la même région que le fournisseur 1

SELECT *
FROM 
    CLIENTS
WHERE 
    PAYS = (SELECT PAYS FROM FOURNISSEURS WHERE NUMÉRO_FOURNISSEUR = 1) AND
    VILLE = (SELECT VILLE FROM FOURNISSEURS WHERE NUMÉRO_FOURNISSEUR = 1) AND
    RIGHT(CODE_POSTAL, 3) = RIGHT((SELECT CODE_POSTAL FROM FOURNISSEURS WHERE NUMÉRO_FOURNISSEUR = 1), 3);

-- 4 Nouveau taux de remise pour les commandes 10998 à 11003

-- 5 Affichez les fournisseurs de boissons

SELECT 
    NUMÉRO_FOURNISSEUR, 
    SOCIÉTÉ, 
    ADRESSE, 
    TÉLÉPHONE
FROM 
    FOURNISSEURS
WHERE 
    NUMÉRO_FOURNISSEUR IN (
        SELECT NUMÉRO_FOURNISSEUR 
        FROM PRODUITS 
        WHERE CODE_CATEGORIE = (SELECT CODE_CATEGORIE FROM CATÉGORIES WHERE NOM_CATEGORIE = 'Boissons')
    );

-- 6 Clients de Berlin avec 0 ou 1 produit dessert commandé

-- 7 Clients en France avec commandes passées chaque lundi en avril 1998

-- 8 Clients ayant commandé tous les produits

SELECT 
    C.CODE_CLIENT, 
    C.ENTREPRISE, 
    C.TÉLÉPHONE
FROM 
    CLIENTS C
WHERE 
    NOT EXISTS (
        SELECT 1 
        FROM PRODUITS P
        WHERE NOT EXISTS (
            SELECT 1 
            FROM DÉTAILS_DE_LA_COMMANDE D
            JOIN COMMANDES CM ON D.NUMÉRO_COMMANDE = CM.NUMÉRO_COMMANDE
            WHERE CM.CODE_CLIENT = C.CODE_CLIENT AND D.RÉFÉRENCE_PRODUIT = P.RÉFÉRENCE_PRODUIT
        )
    );

-- 9 Nombre de commandes en 1996, 1997 et différence

SELECT 
    (SELECT COUNT(*) FROM COMMANDES WHERE YEAR(DATE_COMMANDE) = 1996) AS COMMANDES_1996,
    (SELECT COUNT(*) FROM COMMANDES WHERE YEAR(DATE_COMMANDE) = 1997) AS COMMANDES_1997,
    ABS(
        (SELECT COUNT(*) FROM COMMANDES WHERE YEAR(DATE_COMMANDE) = 1996) -
        (SELECT COUNT(*) FROM COMMANDES WHERE YEAR(DATE_COMMANDE) = 1997)
    ) AS DIFFÉRENCE;